@let currentRows = !selectedTab ? [] : rows(selectedTab);
@let data = currentRows.slice((pageNumber - 1) * pageSize, pageNumber * pageSize);
@let maxpage = ceil(currentRows.length / pageSize);
@let columns = !selectedTab ? [] : fields(selectedTab);

<ul class="Tabs">
  @if (showSingleTab || allowHideColumns || allTabs.length > 1) {
  @for (s of allTabs; track s) {
  @let count = s == selectedTab ? currentRows.length : rows(s).length;
  <li (click)="tabChange(s)"
      [ngClass]="{Active: s == selectedTab}"
      [style.maxWidth]="'calc(100% / '+(allTabs.length + 5)+')'"
      [title]="s">
    {{s}}
    @if (count > 0) {
    ({{count}})
    }
  </li>
  }
  }
  @if (allowHideColumns) {
  <li class="Edit"
      (click)="editColumns = true"
      title="Edit columns">
    ⚙
  </li>
  }
  @if (export) {
  <img (click)="export(selectedTab, currentRows)"
       src="{{excelIcon}}"
       alt="Export to excel"
       title="Export to excel"
       height="32" 
       class="Export">
  }
</ul>
<div class="table-wrapper"
     [style.maxHeight]="tableHeight"
     [style.visibility]="hasLoadedData ? 'visible' : 'hidden'">
  <table class="table">
    <thead>
      <tr>
        @if (allowSelection) {
        <th style="width: 30px;"
            rowspan="2">
          #
        </th>
        }
        @for (col of columns; track col.field || col.headerName || $index; let colIndex = $index) {
        @let filter = filterContains(col.field);
        <th [style.minWidth.px]="col.width"
            [title]="col.headerTooltip || col.headerName || ''"
            [style.cursor]="col.sortable === false ? 'default' : 'pointer'"
            (click)="sortChange(col)"
            [colSpan]="col.children?.length || 1"
            [rowSpan]="(col.children?.length || 1) == 1 ? 2 : 1">
          {{niceName(col)}}
          @if (sortContains(col.field, 'desc')) {
          <i>&uarr;</i>
          }
          @if (sortContains(col.field, 'asc')) {
          <i>&darr;</i>
          }
          @if (col.filter) {
          <i (click)="filterToggle(col, $event)"
             [style.color]="filter.equals || filter.greater || filter.less || filter.contains ? 'darkorange' : 'black'">&#9776;</i>
          @if (col._filtervisible) {
          <div class="options">
            @switch (col.filter) {
            @case ('select') {
            <select (click)="$event.stopPropagation()"
                    [name]="'ColFlt_'+colIndex"
                    (ngModelChange)="filterChange(col, 'equals', $event)"
                    [ngModel]="filter.equals">
              <option value="">-- All --</option>
              @for (option of filterDistinct(col.field); track option) {
              <option [value]="option">{{option}}</option>
              }
            </select>
            }
            @case ('number') {
            Equals:<br>
            <input type="number"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_'+colIndex"
                   (ngModelChange)="filterChange(col, 'equals', $event)"
                   [ngModel]="filter.equals" />
            <br>
            From:<br>
            <input type="number"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_S'+colIndex"
                   (ngModelChange)="filterChange(col, 'greater', $event)"
                   [ngModel]="filter.greater" />
            <br>
            To:<br>
            <input type="number"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_E'+colIndex"
                   (ngModelChange)="filterChange(col, 'less', $event)"
                   [ngModel]="filter.less" />
            }
            @case ('date') {
            From:<br>
            <input type="date"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_S'+colIndex"
                   (ngModelChange)="filterChange(col, 'greater', $event)"
                   [ngModel]="filter.greater" />
            <br>
            To:<br>
            <input type="date"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_E'+colIndex"
                   (ngModelChange)="filterChange(col, 'less', $event)"
                   [ngModel]="filter.less" />
            }
            @default {
            <input type="text"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_'+colIndex"
                   (ngModelChange)="filterChange(col, 'contains', $event)"
                   [ngModel]="filter.contains" />
            }
            }
            <div><button (click)="filterToggle(col, $event)">Close</button></div>
          </div>
          }
          }
          <span class="resize"
                (mousedown)="startResize($event, col)"
                (click)="$event.stopPropagation()"></span>
        </th>
        }
      </tr>
      <tr>
        @for (parent of columns; track parent.field || parent.headerName || $index) {
        @if (parent.children?.length || 1 > 1) {
        @for (col of parent.children; track col.field || col.headerName || $index; let colIndex = $index) {
        @let filter = filterContains(col.field);
        <th [style.minWidth.px]="col.width"
            [title]="col.headerTooltip || col.headerName || ''"
            [style.cursor]="col.sortable === false ? 'default' : 'pointer'"
            (click)="sortChange(col)">
          {{niceName(col)}}
          @if (sortContains(col.field, 'desc')) {
          <i>&uarr;</i>
          }
          @if (sortContains(col.field, 'asc')) {
          <i>&darr;</i>
          }
          @if (col.filter) {
          <i (click)="filterToggle(col, $event)"
             [style.color]="filter.equals || filter.greater || filter.less || filter.contains ? 'darkorange' : 'black'">&#9776;</i>
          @if (col._filtervisible) {
          <div class="options">
            @switch (col.filter) {
            @case ('select') {
            <select (click)="$event.stopPropagation()"
                    [name]="'ColFlt_'+colIndex"
                    (ngModelChange)="filterChange(col, 'equals', $event)"
                    [ngModel]="filter.equals">
              <option value="">-- All --</option>
              @for (option of filterDistinct(col.field); track option) {
              <option [value]="option">{{option}}</option>
              }
            </select>
            }
            @case ('number') {
            Equals:<br>
            <input type="number"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_'+colIndex"
                   (ngModelChange)="filterChange(col, 'equals', $event)"
                   [ngModel]="filter.equals" />
            <br>
            From:<br>
            <input type="number"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_S'+colIndex"
                   (ngModelChange)="filterChange(col, 'greater', $event)"
                   [ngModel]="filter.greater" />
            <br>
            To:<br>
            <input type="number"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_E'+colIndex"
                   (ngModelChange)="filterChange(col, 'less', $event)"
                   [ngModel]="filter.less" />
            }
            @case ('date') {
            From:<br>
            <input type="date"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_S'+colIndex"
                   (ngModelChange)="filterChange(col, 'greater', $event)"
                   [ngModel]="filter.greater" />
            <br>
            To:<br>
            <input type="date"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_E'+colIndex"
                   (ngModelChange)="filterChange(col, 'less', $event)"
                   [ngModel]="filter.less" />
            }
            @default {
            <input type="text"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_'+colIndex"
                   (ngModelChange)="filterChange(col, 'contains', $event)"
                   [ngModel]="filter.contains" />
            }
            }
            <div><button (click)="filterToggle(col, $event)">Close</button></div>
          </div>
          }
          }
          <span class="resize"
                (mousedown)="startResize($event, col)"
                (click)="$event.stopPropagation()"></span>
        </th>
        }
        }
        }
      </tr>
    </thead>
    <tbody>
      @if (data.length == 0 && !loading) {
      <tr>
        <td colspan="999"
            style="min-height: 100px;">
          No data to display for page {{pageNumber}} of {{maxpage}}
        </td>
      </tr>
      }
      @else if (currentRows.length == 0 && loading) {
      <tr>
        <td colspan="999"
            style="min-height: 100px;">
          Loading...
        </td>
      </tr>
      }
      @else {
      @for (row of data; track row['id'] || row['reference'] || $index; let rowIndex = $index) {
      <tr [class]="{'selected': row._selected, 'loading': loading }">
        @if (allowSelection) {
        @if (row._selected) {
        <td style="cursor: pointer;"
            (click)="selectionChanged(row)">✔</td>
        }
        @else {
        <td style="cursor: pointer;font-size: 20px;"
            (click)="selectionChanged(row)">☐</td>
        }
        }
        @for (col of columns; track col.field || col.headerName || $index) {
        @if (col.children?.length || 1 > 1) {
        @for (child of col.children; track child.field || child.headerName || $index) {
        @let value = fieldValue(row, child.field);
        @let pointer = beingObserved(child);
        @let hl = hyperlink(row, child);
        @let type = getCellType(child, value);
        <td [title]="value || ''"
            [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
            [style.cursor]="pointer ? 'pointer' : 'default'"
            [class]="{'editable': col.spec && col.field, 'center': col.center || (type == 'date' && col.center !== false) || (type == 'number' && col.center !== false) || (type == 'boolean' && col.center !== false)}"
            (click)="handleCellClick(col, row, $event)">
          @if (child.spec && child.field && (allEditing || row._editing == child.field)) {
          <app-choice [field]="sharepointChoiceField(child.field)"
                      [form]="sharepointChoiceForm(row, child.field)"
                      [spec]="sharepointChoiceSpec(child.spec, child.field)"
                      (change)="handleCellClick(child, row, $event)"
                      (click)="$event.stopPropagation()">
          </app-choice>
          }
          @else {
          @switch (type) {
          @case ('renderer') {
          <div [innerHTML]="child.cellRenderer!(value, row, rowIndex)"></div>
          }
          @case ('date') {
          @if (hl) {
          <a [href]="hl">{{value | date:'dd MMM yy'}}</a>
          }
          @else {
          {{value | date:'dd MMM yy'}}
          }
          }
          @case ('number') {
          @if (hl) {
          <a [href]="hl">{{value | number:'1.0-2'}}</a>
          }
          @else {
          {{value | number:'1.0-2'}}
          }
          }
          @case ('boolean') {
          @if (hl) {
          <a [href]="hl">{{formatBoolean(value)}}</a>
          }
          @else {
          {{formatBoolean(value)}}
          }
          }
          @default {
          @if (hl) {
          <a [href]="hl">{{value}}</a>
          }
          @else {
          {{value}}
          }
          }
          }
          }
        </td>
        }
        }
        @else {
        @let value = fieldValue(row, col.field);
        @let pointer = beingObserved(col);
        @let hl = hyperlink(row, col);
        @let type = getCellType(col, value);
        <td [title]="value || ''"
            [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
            [style.cursor]="pointer ? 'pointer' : 'default'"
            [class]="{'editable': col.spec && col.field, 'center': col.center || (type == 'date' && col.center !== false) || (type == 'number' && col.center !== false) || (type == 'boolean' && col.center !== false)}"
            (click)="handleCellClick(col, row, $event)">
          @if (col.spec && col.field && (allEditing || row._editing == col.field)) {
          <app-choice [field]="sharepointChoiceField(col.field)"
                      [form]="sharepointChoiceForm(row, col.field)"
                      [spec]="sharepointChoiceSpec(col.spec, col.field)"
                      (change)="handleCellClick(col, row, $event)"
                      (click)="$event.stopPropagation()">
          </app-choice>
          }
          @else {
          @switch (type) {
          @case ('renderer') {
          <div [innerHTML]="col.cellRenderer!(value, row, rowIndex)"></div>
          }
          @case ('date') {
          @if (hl) {
          <a [href]="hl">{{value | date:'dd MMM yy'}}</a>
          }
          @else {
          {{value | date:'dd MMM yy'}}
          }
          }
          @case ('number') {
          @if (hl) {
          <a [href]="hl">{{value | number:'1.0-2'}}</a>
          }
          @else {
          {{value | number:'1.0-2'}}
          }
          }
          @case ('boolean') {
          @if (hl) {
          <a [href]="hl">{{formatBoolean(value)}}</a>
          }
          @else {
          {{formatBoolean(value)}}
          }
          }
          @default {
          @if (hl) {
          <a [href]="hl">{{value}}</a>
          }
          @else {
          {{value}}
          }
          }
          }
          }
        </td>
        }
        }
      </tr>
      }
      <tr>
        <td colspan="999"></td>
      </tr>
      }
    </tbody>
  </table>
</div>
<div>
  <div style="float: right;">
    <button (click)="pageNumber = 1"
            [disabled]="pageNumber <= 2">&lt;&lt;</button>
    <button (click)="pageNumber = pageNumber - 1"
            [disabled]="pageNumber <= 1">&lt;</button>
    Page {{pageNumber}} of {{maxpage}}
    <button (click)="pageNumber = pageNumber + 1"
            [disabled]="pageNumber >= maxpage">&gt;</button>
    <button (click)="pageNumber = maxpage"
            [disabled]="pageNumber >= maxpage - 1">&gt;&gt;</button>
  </div>
  <select [(ngModel)]="pageSize"
          style="float: right;"
          name="PageSize"
          (change)="this.pageNumber = 1">
    <option [value]="10">10</option>
    <option [value]="25">25</option>
    <option [value]="50">50</option>
    <option [value]="100">100</option>
    <option [value]="250">250</option>
    <option [value]="500">500</option>
    <option [value]="1000">1000</option>
    <option [value]="100000">Show All</option>
  </select>
</div>

@if (editColumns) {
<div class="Overlay">
  <div class="Modal">
    <h3>
      Hide columns
      <div class="Close"
           (click)="editColumns = false">
        X
      </div>
    </h3>
    <table class="table">
      <tr>
        <th>
          Column
        </th>
        @for (t of allTabs; track t) {
        <th [style.backgroundColor]="t == selectedTab ? '#e6e6e6' : '#f7f7f7'">
          {{t}}
        </th>
        }
      </tr>
      @for (heading of allCols; track heading.field || heading.headerName || $index; let colIndex = $index) {
      @if (heading.children) {
      @for (child of heading.children; track child.field || child.headerName || $index; let childIndex = $index) {
      @if (child.field) {
      <tr>
        <td>
          {{niceName(heading)}} - {{niceName(child)}}
        </td>
        @for (t of allTabs; track t) {
        <td>
          <input type="checkbox"
                 (click)="columnToggle(child, t)"
                 [ngModel]="isHidden(child, t)"
                 [name]="'HideCol_'+colIndex+'_'+childIndex+'_'+t"
                 [disabled]="typeof child.hide === 'function'" />
        </td>
        }
      </tr>
      }
      }
      }
      @else if (heading.field) {
      <tr>
        <td>
          {{niceName(heading)}}
        </td>
        @for (t of allTabs; track t) {
        <td>
          <input type="checkbox"
                 (click)="columnToggle(heading, t)"
                 [ngModel]="isHidden(heading, t)"
                 [name]="'HideCol_'+colIndex+'_'+t"
                 [disabled]="typeof heading.hide === 'function'" />
        </td>
        }
      </tr>
      }
      }
      <tr></tr>
    </table>
  </div>
</div>
}