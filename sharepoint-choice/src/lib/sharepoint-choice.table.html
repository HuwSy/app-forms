
@let results = rows(selectedTab);
@let columns = flds(selectedTab);
<ul class="Tabs"
    style="position: relative;">
  @for (s of allTabs; track $index) {
  @let count = s == selectedTab ? results.length : rows(s).length;
  <li (click)="changeTab(s)"
      [ngClass]="{Active: s == selectedTab}"
      [style.maxWidth]="'calc(90% / '+allTabs.length+')'"
      [title]="s">
    {{s}}
    @if (count > 0) {
      ({{count}})
    }
  </li>
  }
</ul>
<div class="editor">
  <div (click)="editColumns = true">
    Columns
  </div>
</div>
<div class="table-wrapper"
     [style.maxHeight.px]="tableHeight">
<table class="table">
  <thead>
    <tr>
      @for (col of columns; track $index) {
      <th [style.minWidth.px]="col.width"
          [title]="col.headerTooltip || col.headerName || ''"
          (click)="changeSort(col)"
          [colSpan]="col.children?.length || 1"
          [rowSpan]="(col.children?.length || 1) == 1 ? 2 : 1">
        {{niceName(col)}}
        @if (sortContains('!'+col.field)) {
        <i>&uarr;</i>
        }
        @if (sortContains(col.field)) {
        <i>&darr;</i>
        }
        @if (col.filter != null && col.filter != undefined) {
        <i (click)="col.filtervisible = !col.filtervisible;$event.stopPropagation()"
           [style.color]="filter[col.field] ? 'darkorange' : 'black'">&#9776;</i>
        <div [hidden]="!col.filtervisible" class="options">
        @switch (col.filter) {
        @case ('text') {
        <input type="text"
                (click)="$event.stopPropagation()"
                (keyup)="changeFilter(col, 'contains', $event)"
                (change)="changeFilter(col, 'contains', $event)"
                [value]="filter[col.field]?.contains" />
        }
        @case ('select') {
        <select (click)="$event.stopPropagation()"
                (change)="changeFilter(col, 'equals', $event)"
                [value]="filter[col.field]?.equals">
          <option value="">-- All --</option>
          @for (option of distinctContent(col.field); track $index) {
          @if (option != null && option != undefined && option.toString().trim() != '') {
          <option [value]="option">{{option}}</option>
          }
          }
        </select>
        }
        @case ('number') {
        Equals:<br>
        <input type="text"
                (click)="$event.stopPropagation()"
                (keyup)="changeFilter(col, 'equals', $event)"
                (change)="changeFilter(col, 'equals', $event)"
                [value]="filter[col.field]?.equals" />
        <br>
        From:<br>
        <input type="text"
                (click)="$event.stopPropagation()"
                (keyup)="changeFilter(col, 'greater', $event)"
                (change)="changeFilter(col, 'greater', $event)"
                [value]="filter[col.field]?.greater" />
        <br>
        To:<br>
        <input type="text"
                (click)="$event.stopPropagation()"
                (keyup)="changeFilter(col, 'less', $event)"
                (change)="changeFilter(col, 'less', $event)"
                [value]="filter[col.field]?.less" />
        }
        @case ('date') {
        From:<br>
        <input type="date"
                (click)="$event.stopPropagation()"
                (keyup)="changeFilter(col, 'greater', $event)"
                (change)="changeFilter(col, 'greater', $event)"
                [value]="filter[col.field]?.greater" />
        <br>
        To:<br>
        <input type="date"
                (click)="$event.stopPropagation()"
                (keyup)="changeFilter(col, 'less', $event)"
                (change)="changeFilter(col, 'less', $event)"
                [value]="filter[col.field]?.less" />
        }
        }
          <div><button (click)="col.filtervisible = false;$event.stopPropagation()">Close</button></div>
        </div>
        }
        <span class="resize" (mousedown)="startResize($event, col);$event.stopPropagation()" (click)="$event.stopPropagation()"></span>
      </th>
      }
    </tr>
    <tr>
      @for (parent of columns; track $index) {
      @if (parent.children?.length || 1 > 1) {
      @for (col of parent.children; track $index) {
      <th [style.minWidth.px]="col.width"
          [title]="col.headerTooltip || col.headerName || ''"
          (click)="changeSort(col)">
        {{niceName(col)}}
        @if (sortContains('!'+col.field)) {
        <i>&uarr;</i>
        }
        @if (sortContains(col.field)) {
        <i>&darr;</i>
        }
        @if (col.filter != null && col.filter != undefined) {
        <i (click)="col.filterhidden = !col.filterhidden;$event.stopPropagation()"
           [style.color]="filter[col.field] ? 'darkorange' : 'black'">&#9776;</i>
        <div [hidden]="!col.filterhidden" class="options">
        @switch (col.filter) {
        @case ('text') {
        <input type="text"
                (click)="$event.stopPropagation()"
                (keyup)="changeFilter(col, 'contains', $event)"
                (change)="changeFilter(col, 'contains', $event)"
                [value]="filter[col.field]?.contains" />
        }
        @case ('select') {
        <select (click)="$event.stopPropagation()"
                (change)="changeFilter(col, 'equals', $event)"
                [value]="filter[col.field]?.equals">
          <option value="">-- All --</option>
          @for (option of distinctContent(col.field); track $index) {
          @if (option != null && option != undefined && option.toString().trim() != '') {
          <option [value]="option">{{option}}</option>
          }
          }
        </select>
        }
        @case ('number') {
        Equals:<br>
        <input type="text"
                (click)="$event.stopPropagation()"
                (keyup)="changeFilter(col, 'equals', $event)"
                (change)="changeFilter(col, 'equals', $event)"
                [value]="filter[col.field]?.equals" />
        <br>
        From:<br>
        <input type="text"
                (click)="$event.stopPropagation()"
                (keyup)="changeFilter(col, 'greater', $event)"
                (change)="changeFilter(col, 'greater', $event)"
                [value]="filter[col.field]?.greater" />
        <br>
        To:<br>
        <input type="text"
                (click)="$event.stopPropagation()"
                (keyup)="changeFilter(col, 'less', $event)"
                (change)="changeFilter(col, 'less', $event)"
                [value]="filter[col.field]?.less" />
        }
        @case ('date') {
        From:<br>
        <input type="date"
                (click)="$event.stopPropagation()"
                (keyup)="changeFilter(col, 'greater', $event)"
                (change)="changeFilter(col, 'greater', $event)"
                [value]="filter[col.field]?.greater" />
        <br>
        To:<br>
        <input type="date"
                (keyup)="changeFilter(col, 'less', $event)"
                (change)="changeFilter(col, 'less', $event)"
                [value]="filter[col.field]?.less" />
        }
        }
          <div><button (click)="col.filtervisible = false;$event.stopPropagation()">Close</button></div>
        </div>
        }
        <span class="resize" (mousedown)="startResize($event, col);$event.stopPropagation()" (click)="$event.stopPropagation()"></span>
      </th>
      }
      }
      }
    </tr>
  </thead>
  <tbody>
  @if (loading) {
    <tr class="loading">
      <td colspan="999">
        <div class="spin"></div>
      </td>
    </tr>
  }
  @else if (results.length == 0) {
    <tr>
      <td colspan="999">
        No data to display
      </td>
    </tr>
  }
  @else {
    @for (row of results.slice((this.pageNumber - 1) * this.pageSize, this.pageNumber * this.pageSize); track $index) {
    <tr>
      @for (col of columns; track $index; let rowIndex = $index) {
      @if (col.children?.length || 1 > 1) {
      @for (child of col.children; track $index) {
      @if (child.cellRenderer) {
      <td [title]="fieldValue(row, child.field) || ''"
          [style.whiteSpace]="child.nowrap ? 'nowrap' : 'normal'"
          [style.cursor]="col.cellClicked ? 'pointer' : 'default'"
          [class]="{'center': col.center}"
          [innerHTML]="child.cellRenderer(fieldValue(row, child.field), row, rowIndex)"
          (click)="child.cellClicked ? child.cellClicked(row) : rowClicked(row)"></td>
      }
      @else if (col.filter == 'date' || fieldValue(row, child.field)?.toJSON) {
      <td [title]="fieldValue(row, child.field) || ''" 
          [style.whiteSpace]="child.nowrap ? 'nowrap' : 'normal'"
          [style.cursor]="col.cellClicked ? 'pointer' : 'default'"
          class="center"
          (click)="child.cellClicked ? child.cellClicked(row) : rowClicked(row)">{{fieldValue(row, child.field) | date:'dd MMM yy'}}</td>
      }
      @else if (col.filter == 'number' || typeof fieldValue(row, child.field) == 'number') {
      <td [title]="fieldValue(row, child.field) || ''"
          [style.whiteSpace]="child.nowrap ? 'nowrap' : 'normal'"
          [style.cursor]="col.cellClicked ? 'pointer' : 'default'"
          class="center"
          (click)="child.cellClicked ? child.cellClicked(row) : rowClicked(row)">{{fieldValue(row, child.field) | number:'1.0-2'}}</td>
      }
      @else if (typeof fieldValue(row, child.field) == 'boolean') {
      <td [title]="fieldValue(row, child.field) || ''"
          [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
          [style.cursor]="col.cellClicked ? 'pointer' : 'default'"
          class="center"
          (click)="child.cellClicked ? child.cellClicked(row) : rowClicked(row)">{{fieldValue(row, child.field) ? '✔' : ''}}</td>
      }
      @else {
      <td [title]="fieldValue(row, child.field) || ''"
          [style.whiteSpace]="child.nowrap ? 'nowrap' : 'normal'"
          [style.cursor]="col.cellClicked ? 'pointer' : 'default'"
          [class]="{'center': col.center}"
          (click)="child.cellClicked ? child.cellClicked(row) : rowClicked(row)">{{fieldValue(row, child.field)}}</td>
      }
      }
      }
      @else {
      @if (col.cellRenderer) {
      <td [title]="fieldValue(row, col.field) || ''"
          [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
          [style.cursor]="col.cellClicked ? 'pointer' : 'default'"
          [class]="{'center': col.center}"
          [innerHTML]="col.cellRenderer(fieldValue(row, col.field), row, rowIndex)"
          (click)="col.cellClicked ? col.cellClicked(row) : rowClicked(row)"></td>
      }
      @else if (col.filter == 'date' || fieldValue(row, col.field)?.toJSON) {
      <td [title]="fieldValue(row, col.field) || ''"
          [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
          [style.cursor]="col.cellClicked ? 'pointer' : 'default'"
          class="center"
          (click)="col.cellClicked ? col.cellClicked(row) : rowClicked(row)">{{fieldValue(row, col.field) | date:'dd MMM yy'}}</td>
      }
      @else if (col.filter == 'number' || typeof fieldValue(row, col.field) == 'number') {
      <td [title]="fieldValue(row, col.field) || ''"
          [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
          [style.cursor]="col.cellClicked ? 'pointer' : 'default'"
          class="center"
          (click)="col.cellClicked ? col.cellClicked(row) : rowClicked(row)">{{fieldValue(row, col.field) | number:'1.0-2'}}</td>
      }
      @else if (typeof fieldValue(row, col.field) == 'boolean') {
      <td [title]="fieldValue(row, col.field) || ''"
          [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
          [style.cursor]="col.cellClicked ? 'pointer' : 'default'"
          class="center"
          (click)="col.cellClicked ? col.cellClicked(row) : rowClicked(row)">{{fieldValue(row, col.field) ? '✔' : ''}}</td>
      }
      @else {
      <td [title]="fieldValue(row, col.field) || ''"
          [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
          [style.cursor]="col.cellClicked ? 'pointer' : 'default'"
          [class]="{'center': col.center}"
          (click)="col.cellClicked ? col.cellClicked(row) : rowClicked(row)">{{fieldValue(row, col.field)}}</td>
      }
      }
      }
    </tr>
    }
  }
  </tbody>
</table>
</div>
<div>
  <div style="float: right;">
    <button (click)="pageNumber = pageNumber - 1"
            [disabled]="pageNumber <= 1">&lt;</button>
    Page {{pageNumber}} of {{ceil(results.length / pageSize)}}
    <button (click)="pageNumber = pageNumber + 1"
            [disabled]="pageNumber >= (results.length / pageSize)">&gt;</button>
  </div>
  <select [(ngModel)]="pageSize"
          style="float: left;"
          (change)="pageNumber = 1">
    <option [value]="10">10</option>
    <option [value]="25">25</option>
    <option [value]="50">50</option>
    <option [value]="100">100</option>
    <option [value]="500">500</option>
    <option [value]="1000">1000</option>
  </select>
</div>

@if (editColumns) {
<div class="Overlay">
  <div class="Modal">
    <h3>
      Hide columns for {{selectedTab}}
      <div class="Close"
           (click)="editColumns = false">
        X
      </div>
    </h3>
    @for (heading of flds(); track $index) {
    <ul class="cols">
      @if (heading.children) {
      @for (child of heading.children; track $index) {
      @if (child.field && typeof child.hide !== 'function') {
      <li>
        {{heading.headerName || ''}}
        -
        {{child.headerName || child.field}}
        <input type="checkbox"
               (click)="toggleColumn(child)"
               [(ngModel)]="child.hide" />
      </li>
      }
      }
      }
      @else if (heading.field && typeof heading.hide !== 'function') {
      <li>
        {{heading.headerName || heading.field}}
        <input type="checkbox"
               (click)="toggleColumn(heading)"
               [(ngModel)]="heading.hide" />
      </li>
      }
    </ul>
    }
  </div>
</div>
}
