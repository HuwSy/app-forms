@let results = rows(selectedTab);
@let columns = flds(selectedTab);
@let maxpage = ceil(results.length / pageSize);

@if (allTabs.length > 1) {
<ul class="Tabs"
    style="position: relative;">
  @for (s of allTabs; track $index) {
  @let count = s == selectedTab ? results.length : rows(s).length;
  <li (click)="changeTab(s)"
      [ngClass]="{Active: s == selectedTab}"
      [style.maxWidth]="'calc(90% / '+allTabs.length+')'"
      [title]="s">
    {{s}}
    @if (count > 0) {
    ({{count}})
    }
  </li>
  }
</ul>
}
<div class="editor">
  <div (click)="editColumns = true">
    Columns
  </div>
</div>
<div class="table-wrapper"
     [style.maxHeight]="tableHeight">
  <table class="table">
    <thead>
      <tr>
        @if (allowSelection) {
        <th style="width: 30px;"
            rowspan="2">
          #
        </th>
        }
        @for (col of columns; track $index; let colIndex = $index) {
        @let filter = filterOpts(col.field);
        <th [style.minWidth.px]="col.width"
            [title]="col.headerTooltip || col.headerName || ''"
            [style.cursor]="col.sortable === false ? 'default' : 'pointer'"
            (click)="changeSort(col)"
            [colSpan]="col.children?.length || 1"
            [rowSpan]="(col.children?.length || 1) == 1 ? 2 : 1">
          {{niceName(col)}}
          @if (sortContains('!'+col.field)) {
          <i>&uarr;</i>
          }
          @if (sortContains(col.field)) {
          <i>&darr;</i>
          }
          @if (col.filter) {
          <i (click)="toggleFilter(col, $event)"
             [style.color]="filter.equals || filter.greater || filter.less || filter.contains ? 'darkorange' : 'black'">&#9776;</i>
          @if (col._filtervisible) {
          <div class="options">
            @switch (col.filter) {
            @case ('select') {
            <select (click)="$event.stopPropagation()"
                    [name]="'ColFlt_'+colIndex"
                    (change)="changeFilter(col, 'equals', $event)"
                    [ngModel]="filter.equals">
              <option value="">-- All --</option>
              @for (option of distinctContent(col.field); track $index) {
              <option [value]="option">{{option}}</option>
              }
            </select>
            }
            @case ('number') {
            Equals:<br>
            <input type="text"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_'+colIndex"
                   (keyup)="changeFilter(col, 'equals', $event)"
                   (change)="changeFilter(col, 'equals', $event)"
                   [ngModel]="filter.equals" />
            <br>
            From:<br>
            <input type="text"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_S'+colIndex"
                   (keyup)="changeFilter(col, 'greater', $event)"
                   (change)="changeFilter(col, 'greater', $event)"
                   [ngModel]="filter.greater" />
            <br>
            To:<br>
            <input type="text"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_E'+colIndex"
                   (keyup)="changeFilter(col, 'less', $event)"
                   (change)="changeFilter(col, 'less', $event)"
                   [ngModel]="filter.less" />
            }
            @case ('date') {
            From:<br>
            <input type="date"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_S'+colIndex"
                   (keyup)="changeFilter(col, 'greater', $event)"
                   (change)="changeFilter(col, 'greater', $event)"
                   [ngModel]="filter.greater" />
            <br>
            To:<br>
            <input type="date"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_E'+colIndex"
                   (keyup)="changeFilter(col, 'less', $event)"
                   (change)="changeFilter(col, 'less', $event)"
                   [ngModel]="filter.less" />
            }
            @default {
            <input type="text"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_'+colIndex"
                   (keyup)="changeFilter(col, 'contains', $event)"
                   (change)="changeFilter(col, 'contains', $event)"
                   [ngModel]="filter.contains" />
            }
            }
            <div><button (click)="toggleFilter(col, $event)">Close</button></div>
          </div>
          }
          }
          <span class="resize"
                (mousedown)="startResize($event, col)"
                (click)="$event.stopPropagation()"></span>
        </th>
        }
      </tr>
      <tr>
        @for (parent of columns; track $index) {
        @if (parent.children?.length || 1 > 1) {
        @for (col of parent.children; track $index; let colIndex = $index) {
        @let filter = filterOpts(col.field);
        <th [style.minWidth.px]="col.width"
            [title]="col.headerTooltip || col.headerName || ''"
            [style.cursor]="col.sortable === false ? 'default' : 'pointer'"
            (click)="changeSort(col)">
          {{niceName(col)}}
          @if (sortContains('!'+col.field)) {
          <i>&uarr;</i>
          }
          @if (sortContains(col.field)) {
          <i>&darr;</i>
          }
          @if (col.filter) {
          <i (click)="toggleFilter(col, $event)"
             [style.color]="filter.equals || filter.greater || filter.less || filter.contains ? 'darkorange' : 'black'">&#9776;</i>
          @if (col._filtervisible) {
          <div class="options">
            @switch (col.filter) {
            @case ('select') {
            <select (click)="$event.stopPropagation()"
                    [name]="'ColFlt_'+colIndex"
                    (change)="changeFilter(col, 'equals', $event)"
                    [ngModel]="filter.equals">
              <option value="">-- All --</option>
              @for (option of distinctContent(col.field); track $index) {
              <option [value]="option">{{option}}</option>
              }
            </select>
            }
            @case ('number') {
            Equals:<br>
            <input type="text"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_'+colIndex"
                   (keyup)="changeFilter(col, 'equals', $event)"
                   (change)="changeFilter(col, 'equals', $event)"
                   [ngModel]="filter.equals" />
            <br>
            From:<br>
            <input type="text"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_S'+colIndex"
                   (keyup)="changeFilter(col, 'greater', $event)"
                   (change)="changeFilter(col, 'greater', $event)"
                   [ngModel]="filter.greater" />
            <br>
            To:<br>
            <input type="text"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_E'+colIndex"
                   (keyup)="changeFilter(col, 'less', $event)"
                   (change)="changeFilter(col, 'less', $event)"
                   [ngModel]="filter.less" />
            }
            @case ('date') {
            From:<br>
            <input type="date"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_S'+colIndex"
                   (keyup)="changeFilter(col, 'greater', $event)"
                   (change)="changeFilter(col, 'greater', $event)"
                   [ngModel]="filter.greater" />
            <br>
            To:<br>
            <input type="date"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_E'+colIndex"
                   (keyup)="changeFilter(col, 'less', $event)"
                   (change)="changeFilter(col, 'less', $event)"
                   [ngModel]="filter.less" />
            }
            @default {
            <input type="text"
                   (click)="$event.stopPropagation()"
                   [name]="'ColFlt_'+colIndex"
                   (keyup)="changeFilter(col, 'contains', $event)"
                   (change)="changeFilter(col, 'contains', $event)"
                   [ngModel]="filter.contains" />
            }
            }
            <div><button (click)="toggleFilter(col, $event)">Close</button></div>
          </div>
          }
          }
          <span class="resize"
                (mousedown)="startResize($event, col)"
                (click)="$event.stopPropagation()"></span>
        </th>
        }
        }
        }
      </tr>
    </thead>
    <tbody>
      @if (results.length == 0) {
      <tr class="loading">
        <td colspan="999">
          No data to display
        </td>
      </tr>
      }
      @else {
      @if (loading) {
      <tr class="loading">
        <td colspan="999">
          <div class="spin"></div>
        </td>
      </tr>
      }
      @for (row of results.slice((this.pageNumber - 1) * this.pageSize, this.pageNumber * this.pageSize); track $index; let rowIndex = $index) {
      <tr>
        @if (allowSelection) {
        @if (row.selected) {
        <td style="cursor: pointer;"
            (click)="selectionChanged(row)">✔</td>
        }
        @else {
        <td style="cursor: pointer;font-size: 20px;"
            (click)="selectionChanged(row)">☐</td>
        }
        }
        @for (col of columns; track $index) {
        @if (col.children?.length || 1 > 1) {
        @for (child of col.children; track $index) {
        @let value = fieldValue(row, child.field);
        @if (child.cellRenderer) {
        <td [title]="value || ''"
            [style.whiteSpace]="child.nowrap ? 'nowrap' : 'normal'"
            [style.cursor]="child.cellClicked || rowClicked ? 'pointer' : 'default'"
            [class]="{'center': child.center}"
            [innerHTML]="child.cellRenderer(value, row, rowIndex)"
            (click)="handleCellClick(child.cellClicked, row, $event)"></td>
        }
        @else if (child.filter == 'date' || value?.toJSON) {
        <td [title]="value || ''"
            [style.whiteSpace]="child.nowrap ? 'nowrap' : 'normal'"
            [style.cursor]="child.cellClicked || rowClicked ? 'pointer' : 'default'"
            class="center"
            (click)="handleCellClick(child.cellClicked, row, $event)">{{value | date:'dd MMM yy'}}</td>
        }
        @else if (child.filter == 'number' || typeof value == 'number') {
        <td [title]="value || ''"
            [style.whiteSpace]="child.nowrap ? 'nowrap' : 'normal'"
            [style.cursor]="child.cellClicked || rowClicked ? 'pointer' : 'default'"
            class="center"
            (click)="handleCellClick(child.cellClicked, row, $event)">{{value | number:'1.0-2'}}</td>
        }
        @else if (typeof value == 'boolean') {
        <td [title]="value || ''"
            [style.whiteSpace]="child.nowrap ? 'nowrap' : 'normal'"
            [style.cursor]="child.cellClicked || rowClicked ? 'pointer' : 'default'"
            class="center"
            (click)="handleCellClick(child.cellClicked, row, $event)">{{value ? '✔' : ''}}</td>
        }
        @else {
        <td [title]="value || ''"
            [style.whiteSpace]="child.nowrap ? 'nowrap' : 'normal'"
            [style.cursor]="child.cellClicked || rowClicked ? 'pointer' : 'default'"
            [class]="{'center': child.center}"
            (click)="handleCellClick(child.cellClicked, row, $event)">{{value}}</td>
        }
        }
        }
        @else {
        @let value = fieldValue(row, col.field);
        @if (col.cellRenderer) {
        <td [title]="value || ''"
            [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
            [style.cursor]="col.cellClicked || rowClicked ? 'pointer' : 'default'"
            [class]="{'center': col.center}"
            [innerHTML]="col.cellRenderer(value, row, rowIndex)"
            (click)="handleCellClick(col.cellClicked, row, $event)"></td>
        }
        @else if (col.filter == 'date' || value?.toJSON) {
        <td [title]="value || ''"
            [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
            [style.cursor]="col.cellClicked || rowClicked ? 'pointer' : 'default'"
            class="center"
            (click)="handleCellClick(col.cellClicked, row, $event)">{{value | date:'dd MMM yy'}}</td>
        }
        @else if (col.filter == 'number' || typeof value == 'number') {
        <td [title]="value || ''"
            [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
            [style.cursor]="col.cellClicked || rowClicked ? 'pointer' : 'default'"
            class="center"
            (click)="handleCellClick(col.cellClicked, row, $event)">{{value | number:'1.0-2'}}</td>
        }
        @else if (typeof value == 'boolean') {
        <td [title]="value || ''"
            [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
            [style.cursor]="col.cellClicked || rowClicked ? 'pointer' : 'default'"
            class="center"
            (click)="handleCellClick(col.cellClicked, row, $event)">{{value ? '✔' : ''}}</td>
        }
        @else {
        <td [title]="value || ''"
            [style.whiteSpace]="col.nowrap ? 'nowrap' : 'normal'"
            [style.cursor]="col.cellClicked || rowClicked ? 'pointer' : 'default'"
            [class]="{'center': col.center}"
            (click)="handleCellClick(col.cellClicked, row, $event)">{{value}}</td>
        }
        }
        }
      </tr>
      }
      }
    </tbody>
  </table>
</div>
<div>
  <div style="float: right;">
    <button (click)="pageNumber = 1"
            [disabled]="pageNumber <= 2">&lt;&lt;</button>
    <button (click)="pageNumber = pageNumber - 1"
            [disabled]="pageNumber <= 1">&lt;</button>
    Page {{pageNumber}} of {{maxpage}}
    <button (click)="pageNumber = pageNumber + 1"
            [disabled]="pageNumber >= maxpage">&gt;</button>
    <button (click)="pageNumber = maxpage"
            [disabled]="pageNumber >= maxpage - 1">&gt;&gt;</button>
  </div>
  <select [(ngModel)]="pageSize"
          style="float: left;"
          name="PageSize"
          (change)="setPageSize()">
    <option [value]="10">10</option>
    <option [value]="25">25</option>
    <option [value]="50">50</option>
    <option [value]="100">100</option>
    <option [value]="250">250</option>
    <option [value]="500">500</option>
  </select>
</div>

@if (editColumns) {
<div class="Overlay">
  <div class="Modal">
    <h3>
      Hide columns for {{selectedTab}}
      <div class="Close"
           (click)="editColumns = false">
        X
      </div>
    </h3>
    @for (heading of flds(); track $index; let colIndex = $index) {
    <ul class="cols">
      @if (heading.children) {
      @for (child of heading.children; track $index; let childIndex = $index) {
      @if (child.field && typeof child.hide !== 'function') {
      <li>
        {{heading.headerName || ''}}
        -
        {{child.headerName || child.field}}
        <input type="checkbox"
               (click)="toggleColumn(child)"
               [(ngModel)]="child.hide"
               [name]="'HideCol_'+colIndex+'_'+childIndex" />
      </li>
      }
      }
      }
      @else if (heading.field && typeof heading.hide !== 'function') {
      <li>
        {{heading.headerName || heading.field}}
        <input type="checkbox"
               (click)="toggleColumn(heading)"
               [(ngModel)]="heading.hide"
               [name]="'HideCol_'+colIndex" />
      </li>
      }
    </ul>
    }
  </div>
</div>
}